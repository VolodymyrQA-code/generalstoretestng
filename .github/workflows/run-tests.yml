name: UI Tests with Allure

on:
  push:
  pull_request:

jobs:
  android-test:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.19.0

      - name: Install Appium (Android)
        run: |
          npm install -g appium@3.0.2
          appium driver install uiautomator2

      - name: Start Appium server (Android)
        run: |
          nohup appium -p 4723 --log appium-android.log --base-path /wd/hub > appium-android.log 2>&1 &
          sleep 10
          curl -s http://127.0.0.1:4723/wd/hub/status

      - name: Start Android emulator and run tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86
          profile: pixel_4
          disable-animations: true
          ram-size: 2048M
          heap-size: 512M
          script: |
            export CI=true
            adb install -r $GITHUB_WORKSPACE/app/General-Store.apk
            mvn -B clean test -Pandroid -Dsurefire.useFile=false -Dallure.results.directory=target/allure-results || TEST_EXIT_CODE=$?
            exit ${TEST_EXIT_CODE:-0}

      - name: Upload Android screenshots
        uses: actions/upload-artifact@v4
        with:
          name: android-screenshots
          path: target/screenshots/

      - name: Upload Android Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-allure-report
          path: target/site/allure-report/

  ios-test:
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Appium and XCUITest driver
        run: |
          npm install -g appium@3.0.2
          appium driver install xcuitest
          echo "‚úÖ Appium installed"
          appium -v

      # üß© –û—Å—å —Ç—É—Ç –¥–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Start iOS Simulator
        shell: bash
        run: |
          SIM_DEVICE=$(xcrun simctl list devices available | grep 'iPhone 14' | head -1 | awk -F '[()]' '{print $2}')
          if [ -z "$SIM_DEVICE" ]; then
            echo "‚ùå iPhone 14 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —à—É–∫–∞—î–º–æ –±—É–¥—å-—è–∫–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π iPhone..."
            SIM_DEVICE=$(xcrun simctl list devices available | grep 'iPhone' | head -1 | awk -F '[()]' '{print $2}')
          fi

          if [ -z "$SIM_DEVICE" ]; then
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∂–æ–¥–µ–Ω —Å–∏–º—É–ª—è—Ç–æ—Ä iPhone. –ü–µ—Ä–µ—Ä–∏–≤–∞—é —Ä–æ–±–æ—Ç—É."
            exit 1
          fi

          echo "üì± Booting simulator with UDID: $SIM_DEVICE"
          xcrun simctl boot "$SIM_DEVICE" || echo "‚ö†Ô∏è Simulator already booted"
          xcrun simctl list devices
          sleep 20
